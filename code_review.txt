================================================================================
                    HITSOUND DAW - CODE REVIEW REPORT
                         Generated: 2025-12-08
================================================================================

OVERVIEW
--------
Complete code review of the Hitsound DAW codebase identifying potential issues
and improvement opportunities.

================================================================================
                           CRITICAL ISSUES (2)
================================================================================

[FIXED] Issue #1: Thread Safety in EventPlaybackSource
-------------------------------------------------------
File: audio/EventPlaybackSource.cpp

Problem: getNextAudioBlock() directly read from tracks vector owned by UI thread.
This could cause data races, crashes, or audio glitches if UI modifies tracks
while audio is playing.

Fix Applied:
- Added SpinLock protected tracksSnapshot copy
- Added updateTracksSnapshot() method for UI thread to sync changes
- Added OnTracksModified callback wiring from TimelineView -> MainFrame -> AudioEngine

--------------------------------------------------------------------------------

[FIXED] Issue #2: goto Statement in Multiple Files
-------------------------------------------------
Files: TimelineView.cpp, TrackList.cpp

Fix Applied:
- Replaced goto statements with helper lambdas that return early
- TimelineView.cpp: findRowIndex lambda replaces goto found_row
- TrackList.cpp: findChildTargetY and findTrackAtY lambdas replace goto found_y/found

================================================================================
                          MEDIUM PRIORITY ISSUES (8)
================================================================================

[FIXED] Issue #3: Child Track Detection is Fragile
---------------------------------------------------
Files: TimelineView.cpp, TrackList.cpp

Problem: Child tracks identified by checking if name contains "%)". Fragile if
user names a track with "%)".

Fix Applied:
- Added isChildTrack boolean flag to Track struct
- Replaced 17 instances of string matching with track.isChildTrack
- Set isChildTrack = true in all 11 places where child tracks are created

--------------------------------------------------------------------------------

[FIXED] Issue #4: Hardcoded Magic Numbers
-----------------------------------------
Files: Multiple

Problem: Many hardcoded values: track heights (80, 40, 100), header height (130),
timer intervals (30, 10).

Fix Applied:
- Created src/Constants.h with organized namespaces:
  * TrackLayout: ParentTrackHeight, ChildTrackHeight, etc.
  * TimerIntervals: PlaybackUpdate, LoopCheck
  * DefaultVolumes: EffectsGain, MasterGain, etc.
  * ZoomSettings: MinPixelsPerSecond, MaxPixelsPerSecond
- Updated TimelineView.h and TimelineView.cpp to use constants

--------------------------------------------------------------------------------

[FIXED] Issue #5: HitObject.h Appears Unused
--------------------------------------------
File: model/HitObject.h

Problem: HitObject struct defined but never included or used anywhere.

Fix Applied: Deleted the unused file.

--------------------------------------------------------------------------------

[FIXED] Issue #6: Audio Engine Inherits Unused Callback Interface
-----------------------------------------------------------------
File: audio/AudioEngine.cpp

Fix Applied:
- Removed juce::AudioIODeviceCallback inheritance from AudioEngine
- Deleted empty callback method declarations and implementations
- AudioSourcePlayer continues to handle actual audio callbacks

--------------------------------------------------------------------------------

[FIXED] Issue #7: Event Matching is Weak in Commands
----------------------------------------------------
File: model/Commands.h

Fix Applied:
- Added unique uint64_t id field to Event struct with atomic ID generator
- Updated all 6 event matching locations in Commands.h to use e.id == evt.id
- Ensures reliable undo/redo even with duplicate time+volume events

--------------------------------------------------------------------------------

[FIXED] Issue #8: Missing Volume Update on Track Edit
-----------------------------------------------------
File: TrackList.cpp:1278

Fix Applied:
- Added logic to extract volume from first child if available
- Falls back to 100 if no children exist

--------------------------------------------------------------------------------

[FIXED] Issue #9: ProjectValidator Only Checks Top-Level Tracks
---------------------------------------------------------------
File: model/ProjectValidator.h

Fix Applied:
- Added recursive collectEvents helper lambda
- Now iterates through all children of each track

--------------------------------------------------------------------------------

[FIXED] Issue #10: primaryChildIndex Adjustment May Be Incorrect
---------------------------------------------------------------
File: TrackList.cpp:1376-1377

Fix Applied:
- Added check for when deleted child WAS the primary (resets to 0)
- Added check for when deleting before primary (decrements index)
- Ensures index always remains valid after deletion

================================================================================
                         MINOR ISSUES (6)
================================================================================

[SKIP] Issue #11: Duplicate Code in Track Abbreviation Generation
The getAbbrev lambda is local to OnPaint - not duplicated elsewhere.

[FIXED - See Issue #1] Issue #12: Unused Member in EventPlaybackSource
juce::MixerAudioSource mixer was unused. Removed during thread safety fix.

[FIXED] Issue #13: Commented-Out Code
Removed btnToolErase references and "// OnToolErase removed" comments.

[FIXED] Issue #14: Missing Null Checks Before Pointer Use
Added null guards for GetParent()->Refresh() calls at lines 907 and 955.

[FIXED] Issue #15: Fixed Master Offset Value
Added documentation explaining the purpose and TODO for configurability.

[FIXED] Issue #16: SampleTypes.h Has Unused Types
Added documentation marking SliderSlide/Tick/Whistle as reserved for future use.

================================================================================
                        SUGGESTIONS (4)
================================================================================

[NOTED] Issue #17: Consider Event Sorting
Events stored unsorted. Sorted order would enable efficient playback scanning
and binary search for hit testing. (Future enhancement)

[NOTED] Issue #18: Centralize Track Height Calculation
GetTrackHeight() helper exists. Integration adequate for current codebase.

[DEFER] Issue #19: Separate Rendering from Data Model
Track contains both data (events, sampleSet) and UI state (isExpanded,
primaryChildIndex). Consider separating concerns. (Architectural change)

[DEFER] Issue #20: Add Unit Tests
No test files found. Critical logic (parser, validation, undo/redo) would
benefit from automated testing. (Requires testing framework setup)

================================================================================
                              SUMMARY
================================================================================

| Priority    | Total | Fixed | Open/Defer |
|-------------|-------|-------|------------|
| Critical    |   2   |   2   |     0      |
| Medium      |   8   |   8   |     0      |
| Minor       |   6   |   5   |   1 skip   |
| Suggestions |   4   |   2   |   2 defer  |
|-------------|-------|-------|------------|
| TOTAL       |  20   |  17   |     3      |

================================================================================
